<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Shared Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <!-- iOS home screen icon -->
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192.png?text=App">
  </head>
  <body>
    <div class="container my-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>ðŸ’¸ Shared Expense Tracker</h1>
        <span class="text-muted">Simple monthly tracking</span>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div>
              {% for cat, msg in messages %}
                <div class="alert alert-{{ 'success' if cat=='success' else 'danger' }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div>
          {% if session.user %}
            <span class="me-2">Signed in as <strong>{{ session.user }}</strong></span>
            <a class="btn btn-sm btn-outline-secondary" href="/logout">Logout</a>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="/login">Login</a>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">âž• Add expense</h5>
              <form action="/add" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-2">
                  <label class="form-label">Date</label>
                  <input type="date" name="tx_date" class="form-control" value="{{ month_start }}">
                </div>
                <div class="mb-2">
                  <label class="form-label">Category</label>
                  <select name="category" class="form-select">
                    {% for c in categories %}
                      <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Payer</label>
                  <select name="payer" class="form-select">
                    {% for p in people %}
                      <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Amount (â‚ª)</label>
                  <input type="number" step="0.01" name="amount" class="form-control">
                </div>
                <div class="mb-2">
                  <label class="form-label">Notes</label>
                  <input type="text" name="notes" class="form-control">
                </div>
                <button class="btn btn-primary">Add expense</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Export</h5>
              <a class="btn btn-outline-secondary" href="/download_csv">Download CSV</a>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="card p-2 text-center">
                <div class="h6">Total this month</div>
                <div class="display-6">â‚ª{{ total|round }}</div>
              </div>
            </div>
            <div class="col-md-4">
                <div class="card p-2 text-center">
                <div class="h6">By person</div>
                <ul class="list-unstyled mb-0">
                  {% for name, amt in by_person_list %}
                    <li>{{ name }}: â‚ª{{ '%.2f'|format(amt) }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card p-2 text-center">
                <div class="h6">By category</div>
                <ul class="list-unstyled mb-0">
                  {% for name, amt in by_cat_list %}
                    <li>{{ name }}: â‚ª{{ '%.2f'|format(amt) }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card p-2">
                <img src="/plot/by_cat.png" class="img-fluid" alt="By category">
              </div>
            </div>
            <div class="col-md-6">
              <div class="card p-2">
                <img src="/plot/by_person.png" class="img-fluid" alt="By person">
              </div>
            </div>
          </div>

          <!-- Budget Progress Charts -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">ðŸ“Š Budget Progress</h5>
              <div class="row">
                {% for person in people %}
                  <div class="col-md-6 mb-3">
                    <div class="card p-2">
                      <h6 class="text-center mb-2">{{ person }}</h6>
                      <img src="/budget/{{ person }}.png" class="img-fluid" alt="{{ person }} budget progress">
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">This month's expenses</h5>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Date</th>
                      <th>Category</th>
                      <th>Amount (â‚ª)</th>
                      <th>Payer</th>
                      <th>Notes</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in records %}
                      <tr>
                        <td>{{ r.id }}</td>
                        <td>{{ r.tx_date }}</td>
                        <td>{{ r.category }}</td>
                        <td>{{ r.amount }}</td>
                        <td>{{ r.payer }}</td>
                        <td>{{ r.notes }}</td>
                        <td>
                          <form method="post" action="/delete" onsubmit="return confirm('Delete this expense?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="row_id" value="{{ r.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/static/sw.js').then(function(reg) {
          console.log('Service worker registered.', reg);
        }).catch(function(err) { console.log('SW register failed: ', err); });
      });
    }
  </script>
</html>
